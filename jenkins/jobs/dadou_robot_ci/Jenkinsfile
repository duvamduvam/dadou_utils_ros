pipeline {
  agent any

  options {
    timestamps()
  }

  stages {
    stage('Prepare defaults') {
      steps {
        script {
          env.DOCKER_IMAGE = env.DOCKER_IMAGE?.trim() ?: 'dadou_robot'
          env.DOCKER_TAG = env.DOCKER_TAG?.trim() ?: "${env.BRANCH_NAME ?: 'main'}-${env.BUILD_NUMBER}"
          env.DOCKER_CONTEXT = env.DOCKER_CONTEXT?.trim() ?: '.'
          env.DOCKERFILE = env.DOCKERFILE?.trim() ?: 'conf/docker/jenkins/Dockerfile-jenkins'
          env.JENKINS_REMOTE_USER = env.JENKINS_REMOTE_USER?.trim() ?: 'pi'
          env.JENKINS_REMOTE_HOST = env.JENKINS_REMOTE_HOST?.trim() ?: '172.17.0.1'
          env.REPO_URL = env.REPO_URL?.trim() ?: 'git@github.com:duvamduvam/dadou_robot_ros.git'
          env.REPO_BRANCH = env.REPO_BRANCH?.trim() ?: 'main'
          env.PYTHON_REQUIREMENTS = env.PYTHON_REQUIREMENTS?.trim() ?: 'requirements.txt'
          env.TEST_COMMAND = env.TEST_COMMAND?.trim() ?: 'pytest -q /home/ros2_ws/src/robot/robot/tests --ignore=/home/ros2_ws/src/robot/robot/tests/sandbox'
          env.WORKSPACE_ROOT = env.WORKSPACE_ROOT?.trim() ?: '/home/pi/jenkins-workspace'
          env.KEEP_WORKDIR = env.KEEP_WORKDIR?.trim() ?: '1'
          env.DOCKER_COMPOSE_FILE = env.DOCKER_COMPOSE_FILE?.trim() ?: 'conf/docker/jenkins/docker-compose-jenkins.yml'
          env.DOCKER_COMPOSE_SERVICE = env.DOCKER_COMPOSE_SERVICE?.trim() ?: 'dadou-robot-jenkins'
          def rawScriptPath = env.CI_SCRIPT_PATH?.trim()
          if (!rawScriptPath || rawScriptPath.isEmpty()) {
            env.CI_SCRIPT_PATH = '/home/pi/jenkins/scripts/run_ci_pipeline.sh'
          } else if (rawScriptPath == '/var/jenkins_home/scripts/run_ci_pipeline.sh') {
            env.CI_SCRIPT_PATH = '/home/pi/jenkins/scripts/run_ci_pipeline.sh'
          } else {
            env.CI_SCRIPT_PATH = rawScriptPath
          }
          env.DOCKER_PUSH_ENABLED = env.DOCKER_PUSH_ENABLED?.trim() ?: 'false'
          env.GITHUB_NOTIFY_ENABLED = env.GITHUB_NOTIFY_ENABLED?.trim() ?: 'true'
          env.GITHUB_NOTIFY_ACCOUNT = env.GITHUB_NOTIFY_ACCOUNT?.trim() ?: 'duvamduvam'
          env.GITHUB_NOTIFY_REPO = env.GITHUB_NOTIFY_REPO?.trim() ?: 'dadou_robot_ros'
          env.GITHUB_NOTIFY_CREDENTIALS_ID = env.GITHUB_NOTIFY_CREDENTIALS_ID?.trim() ?: 'github-token4'
        }
      }
    }

    stage('Run CI script on builder host') {
      steps {
        sh """#!/usr/bin/env bash
set -euo pipefail
ssh -o StrictHostKeyChecking=no ${env.JENKINS_REMOTE_USER}@${env.JENKINS_REMOTE_HOST} \\
  REPO_URL='${env.REPO_URL}' \\
  REPO_BRANCH='${env.REPO_BRANCH}' \\
  WORKSPACE_ROOT='${env.WORKSPACE_ROOT}' \\
  DOCKER_COMPOSE_FILE='${env.DOCKER_COMPOSE_FILE}' \\
  DOCKER_COMPOSE_SERVICE='${env.DOCKER_COMPOSE_SERVICE}' \\
  'bash -s' <<'REMOTE_SCRIPT'
set -euo pipefail

if [ -z "$WORKSPACE_ROOT" ]; then
  echo "WORKSPACE_ROOT is empty; configure the Jenkins job accordingly." >&2
  exit 1
fi

workspace_parent=$(dirname "$WORKSPACE_ROOT")
if [ ! -d "$workspace_parent" ]; then
  mkdir -p "$workspace_parent"
fi

if [ -d "$WORKSPACE_ROOT/.git" ]; then
  git -C "$WORKSPACE_ROOT" fetch origin "$REPO_BRANCH"
  git -C "$WORKSPACE_ROOT" checkout "$REPO_BRANCH"
  git -C "$WORKSPACE_ROOT" reset --hard "origin/$REPO_BRANCH"
  git -C "$WORKSPACE_ROOT" clean -fdx
else
  rm -rf "$WORKSPACE_ROOT"
  git clone --branch "$REPO_BRANCH" "$REPO_URL" "$WORKSPACE_ROOT"
fi

cd "$WORKSPACE_ROOT"

if docker compose version >/dev/null 2>&1; then
  COMPOSE_BIN=(docker compose)
elif command -v docker-compose >/dev/null 2>&1; then
  COMPOSE_BIN=(docker-compose)
else
  echo "docker compose / docker-compose introuvable sur l'hôte builder." >&2
  exit 1
fi

"${COMPOSE_BIN[@]}" -f "$DOCKER_COMPOSE_FILE" down --remove-orphans >/dev/null 2>&1 || true
DOCKER_BUILDKIT=1 "${COMPOSE_BIN[@]}" -f "$DOCKER_COMPOSE_FILE" up --build --abort-on-container-exit --exit-code-from "$DOCKER_COMPOSE_SERVICE" "$DOCKER_COMPOSE_SERVICE"
compose_status=$?
"${COMPOSE_BIN[@]}" -f "$DOCKER_COMPOSE_FILE" down --remove-orphans
exit $compose_status
REMOTE_SCRIPT
"""
      }
    }

    stage('Collect build metadata') {
      when {
        expression { env.GITHUB_NOTIFY_ENABLED?.toBoolean() }
      }
      steps {
        script {
          if (!env.GITHUB_NOTIFY_SHA?.trim()) {
            def remoteWorkspace = env.WORKSPACE_ROOT?.trim()
            if (remoteWorkspace) {
              try {
                env.GITHUB_NOTIFY_SHA = sh(
                  returnStdout: true,
                  script: """#!/usr/bin/env bash
set -euo pipefail
ssh -o StrictHostKeyChecking=no ${env.JENKINS_REMOTE_USER}@${env.JENKINS_REMOTE_HOST} \\
  "cd '${remoteWorkspace}' && git rev-parse HEAD"
"""
                ).trim()
              } catch (err) {
                echo "Unable to fetch commit SHA from remote workspace: ${err.getMessage()}"
              }
            } else {
              echo 'WORKSPACE_ROOT is empty; skipping remote commit lookup.'
            }
          }
        }
      }
    }

    stage('Docker Push') {
      when {
        expression { env.DOCKER_PUSH_ENABLED?.toBoolean() }
      }
      steps {
        sh """#!/usr/bin/env bash
          docker push "${env.DOCKER_IMAGE}:${env.DOCKER_TAG}"
        """
      }
    }
  }

  post {
    always {
      script {
        if (env.GITHUB_NOTIFY_ENABLED?.toBoolean()) {
          def sha = env.GITHUB_NOTIFY_SHA?.trim()
          def repo = env.GITHUB_NOTIFY_REPO?.trim()
          def account = env.GITHUB_NOTIFY_ACCOUNT?.trim()
          def credsId = env.GITHUB_NOTIFY_CREDENTIALS_ID?.trim()
          if (sha && repo && account && credsId) {
            def state = currentBuild.currentResult?.toString()?.toLowerCase() ?: 'error'
            def description = "Build ${state}"
            echo "[GitHub Notify] Posting status '${state}' for ${account}/${repo}@${sha} using credential '${credsId}'."
            withCredentials([string(credentialsId: credsId, variable: 'GITHUB_TOKEN')]) {
              sh label: 'GitHub status update', script: """#!/usr/bin/env bash
set -euo pipefail
curl -sSf -X POST https://api.github.com/repos/${account}/${repo}/statuses/${sha} \\
  -H 'Authorization: Bearer '"\${GITHUB_TOKEN}" \\
  -H 'Accept: application/vnd.github+json' \\
  -d '{
    "state": "${state}",
    "target_url": "${env.BUILD_URL}",
    "description": "${description}",
    "context": "Jenkins CI"
  }'
"""
            }
          } else {
            echo '[GitHub Notify] Skipped because repo/account/sha/credentials metadata missing.'
          }
        } else {
          echo 'GitHub notifications disabled for this pipeline.'
        }
      }
      cleanWs()
    }

    failure {
      script {
        echo "[mail] Preparing failure notification for build #${env.BUILD_NUMBER}."
        def testAction = currentBuild.rawBuild?.getAction(hudson.tasks.junit.TestResultAction)
        def collectNames = { items ->
          items?.collect { it.fullDisplayName ?: it.fullName ?: it.displayName } ?: []
        }
        def failedTests = collectNames(testAction?.failedTests)
        def passedTests = collectNames(testAction?.passedTests)
        def skippedTests = collectNames(testAction?.skippedTests)
        def formatSection = { label, list ->
          if (list && list.size() > 0) {
            "${label} (${list.size()}):\n- " + list.join('\n- ')
          } else {
            "${label}: aucun"
          }
        }
        def bodySections = [
          formatSection('Tests échoués', failedTests),
          formatSection('Tests réussis', passedTests),
          formatSection('Tests ignorés', skippedTests)
        ].join("\n\n")
        def mailBody = "Build ${env.JOB_NAME} #${env.BUILD_NUMBER} a échoué.\n\n${bodySections}\n\nConsole: ${env.BUILD_URL}console"
        try {
          mail to: 'david@duvam.net',
               from: 'jenkins@eternel-life.com',
               subject: "${env.JOB_NAME} #${env.BUILD_NUMBER} FAILED",
               body: mailBody
          echo '[mail] Mail sent successfully.'
        } catch (Throwable err) {
          def sw = new StringWriter()
          err.printStackTrace(new PrintWriter(sw))
          echo "[mail] Mail sending failed: ${err.getMessage()}"
          echo sw.toString()
        }
      }
    }
  }
}
