import hudson.plugins.sonar.*
import hudson.util.Secret
import jenkins.model.Jenkins

def descriptor = Jenkins.get().getDescriptorByType(SonarGlobalConfiguration.class)
if (descriptor == null) {
    println("Sonar plugin not available; skipping Sonar server provisioning.")
    return
}

def name = "{{ jenkins_sonar_server_name }}"
def url = "{{ jenkins_sonar_server_url }}"
def serverVersion = "{{ jenkins_sonar_server_version }}"
def mojoVersion = "{{ jenkins_sonar_server_mojo_version }}"
def additionalProps = """{{ jenkins_sonar_server_additional_properties }}""".trim()
def sonarProps = """{{ jenkins_sonar_server_properties }}""".trim()
def tokenValue = "{{ jenkins_sonar_server_token_value }}"
def secretToken = tokenValue ? Secret.fromString(tokenValue) : null

def newInstallation = new SonarInstallation(
        name,
        url,
        serverVersion,
        secretToken,
        mojoVersion,
        additionalProps,
        sonarProps
)

def installations = descriptor.installations as List ?: []
def updated = false
installations = installations.collect { existing ->
    if (existing.name == name) {
        updated = true
        return newInstallation
    }
    return existing
}

if (!updated) {
    installations << newInstallation
}

descriptor.setInstallations(installations as SonarInstallation[])
descriptor.save()
println("Sonar installation '${name}' registered (updated=${updated}).")
