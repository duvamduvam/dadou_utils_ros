import jenkins.model.*
import hudson.security.*
import jenkins.install.InstallState

def instance = Jenkins.instance
def username = "{{ jenkins_admin_user }}"
def secretRelativePath = "{{ jenkins_admin_password_relative_path }}"
def secretFile = new File(instance.rootDir, secretRelativePath)

if (!secretFile.exists()) {
  println("Jenkins admin secret file '${secretRelativePath}' is missing; skipping admin provisioning.")
  return
}

def password = secretFile.text.trim()
if (!password) {
  println("Jenkins admin secret file '${secretRelativePath}' is empty; skipping admin provisioning.")
  return
}

def securityRealm = instance.getSecurityRealm()
if (!(securityRealm instanceof HudsonPrivateSecurityRealm)) {
  securityRealm = new HudsonPrivateSecurityRealm(false)
  instance.setSecurityRealm(securityRealm)
}

def user = securityRealm.getUser(username)
if (user == null) {
  securityRealm.createAccount(username, password)
  println("Jenkins admin user '${username}' created.")
} else {
  user.changePassword(password)
  println("Jenkins admin user '${username}' password refreshed.")
}

def strategy = instance.getAuthorizationStrategy()
if (!(strategy instanceof FullControlOnceLoggedInAuthorizationStrategy)) {
  instance.setAuthorizationStrategy(new FullControlOnceLoggedInAuthorizationStrategy())
}

if (instance.installState != InstallState.INITIAL_SETUP_COMPLETED) {
  instance.setInstallState(InstallState.INITIAL_SETUP_COMPLETED)
}

instance.save()
