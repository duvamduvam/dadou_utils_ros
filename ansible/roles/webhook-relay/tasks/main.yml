---
- name: Validate mandatory webhook parameters
  ansible.builtin.fail:
    msg: "webhook_relay_smee_url and webhook_relay_target_url must be provided"
  when: (webhook_relay_smee_url | length == 0) or (webhook_relay_target_url | length == 0)

- name: Ensure webhook script directory exists
  ansible.builtin.file:
    path: "{{ webhook_relay_script_path | dirname }}"
    state: directory
    mode: '0755'

- name: Deploy webhook relay script
  ansible.builtin.template:
    src: webhook-script.sh.j2
    dest: "{{ webhook_relay_script_path }}"
    mode: '0755'
  become: yes

- name: Deploy webhook relay systemd unit
  ansible.builtin.template:
    src: webhook-relay.service.j2
    dest: "{{ webhook_relay_service_path }}"
    mode: '0644'
  become: yes

- name: Ensure webhook relay service is enabled and running
  ansible.builtin.systemd:
    name: "{{ webhook_relay_service_name }}"
    enabled: true
    state: started
    daemon_reload: true
