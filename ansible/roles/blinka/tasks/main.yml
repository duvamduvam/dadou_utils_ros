- name: Ensure Blinka install directory exists
  ansible.builtin.file:
    path: "{{ blinka_install_dir }}"
    state: directory
    mode: '0755'

- name: Create Python virtual environment for Blinka tooling
  ansible.builtin.command:
    cmd: python3 -m venv {{ blinka_venv_path }}
    creates: "{{ blinka_venv_path }}/bin/activate"

- name: Install adafruit-python-shell inside the virtual environment
  ansible.builtin.pip:
    name: adafruit-python-shell
    virtualenv: "{{ blinka_venv_path }}"

- name: Download raspi-blinka.py script on control host
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/adafruit/Raspberry-Pi-Installer-Scripts/master/raspi-blinka.py
    dest: "{{ blinka_script_path }}"
    mode: '0755'
  delegate_to: localhost
  run_once: true

- name: Copy raspi-blinka.py to target host
  ansible.builtin.copy:
    src: "{{ blinka_script_path }}"
    dest: "{{ blinka_script_path }}"
    mode: '0755'

- name: Run raspi-blinka.py with automatic answers
  become: yes
  ansible.builtin.shell:
    cmd: "echo '{{ blinka_auto_answer }}' | {{ blinka_venv_path }}/bin/python {{ blinka_script_path }}"
    executable: /bin/bash
  register: blinka_install_result
  ignore_errors: "{{ blinka_ignore_errors }}"

- name: Display raspi-blinka.py output
  ansible.builtin.debug:
    msg: "stdout: {{ blinka_install_result.stdout }} stderr: {{ blinka_install_result.stderr }}"
  when: blinka_install_result is defined
