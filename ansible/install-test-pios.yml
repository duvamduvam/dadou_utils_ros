---
- name: install {{ target_group | default('robot') }} test
  hosts: "{{ target_group | default('robot') }}"
  # Enable become if privileged actions are required

  vars_files:
    - vars/main.yml

  roles:
    - role: dir_struct
      vars:
        directories:
          - "{{ project_ros_dir }}"
          - "{{ project_ros_dir }}/log"
    - role: activate-i2c
    - role: blinka

  tasks:
  - name: Create the log file if needed
    ansible.builtin.file:
      path: "test/logs/{{ target_group }}-test.log"
      state: touch

  - name: Synchronize the test directory
    ansible.builtin.synchronize:
      src: "{{ local_projects_dir }}/{{ local_project_dir }}/"
      dest: "test/"
      recursive: yes
      copy_links: yes
      rsync_opts:
        - "--verbose"
        - "--exclude=.*"
        #- "--exclude=.git/"
        - "--exclude=.~tmp~/"
        - "--exclude=*tar.gz"
        #- "--exclude=.idea/"
        - "--exclude=__pycache__/"
        - "--exclude=venv/"
        #- "--delete"
        #- "--exclude=.editorconfig"
        #- "--exclude=.gitignore"
        #- "--exclude=robot_bringup/"
        #- "--exclude=robot_interfaces/"

  - name: Install audio build dependencies
    become: yes
    ansible.builtin.apt:
      name:
        - portaudio19-dev
        - libasound2-dev
      state: present
      update_cache: yes

  - name: Check for requirements.txt under conf/
    ansible.builtin.stat:
      path: "{{ ansible_env.HOME }}/test/conf/requirements.txt"
    register: conf_requirements_file

  - name: Check for requirements.txt at repository root
    ansible.builtin.stat:
      path: "{{ ansible_env.HOME }}/test/requirements.txt"
    register: root_requirements_file

  - name: Fail if no requirements.txt is available
    ansible.builtin.fail:
      msg: "No requirements.txt found under {{ ansible_env.HOME }}/test"
    when: not conf_requirements_file.stat.exists and not root_requirements_file.stat.exists

  - name: Select requirements.txt path
    ansible.builtin.set_fact:
      test_requirements_path: >-
        {{ (ansible_env.HOME ~ '/test/conf/requirements.txt') if conf_requirements_file.stat.exists else (ansible_env.HOME ~ '/test/requirements.txt') }}

  - name: Install project requirements via python role
    ansible.builtin.import_role:
      name: python
    vars:
      python_venv_path: "{{ ansible_env.HOME }}/test/venv"
      python_requirements_path: "{{ test_requirements_path }}"
