---
- name: install {{ target_group | default('robot') }} test
  hosts: "{{ target_group | default('robot') }}"
  # Enable become if privileged actions are required

  vars_files:
    - vars/main.yml

  roles:
    - role: dir_struct
      vars:
        directories:
          - "{{ project_ros_dir }}"
          - "{{ project_ros_dir }}/log"
    - role: activate-i2c
    - role: blinka
    - role: linux-package
      vars:
        linux_package_file: "{{ playbook_dir }}/../jenkins/jenkins-package.txt"
    - role: python
      vars:
        python_venv_path: "{{ ansible_env.HOME }}/test/venv"
        python_requirements_candidates:
          - "{{ ansible_env.HOME }}/test/conf/requirements.txt"
          - "{{ ansible_env.HOME }}/test/requirements.txt"
        python_requirements_required: false
    - role: set-bashrc
      vars:
        set_bashrc_project_file: "{{ playbook_dir }}/../jenkins/jenkins-bashrc"

  tasks:
  - name: Ensure test log directory exists
    ansible.builtin.file:
      path: "test/logs"
      state: directory
      mode: '0755'

  - name: Create the log file if needed
    ansible.builtin.file:
      path: "test/logs/{{ target_group }}-test.log"
      state: touch

  - name: Synchronize the test directory
    ansible.builtin.synchronize:
      src: "{{ local_projects_dir }}/{{ local_project_dir }}/"
      dest: "test/"
      recursive: yes
      copy_links: yes
      rsync_opts:
        - "--verbose"
        - "--exclude=.*"
        #- "--exclude=.git/"
        - "--exclude=.~tmp~/"
        - "--exclude=*tar.gz"
        #- "--exclude=.idea/"
        - "--exclude=__pycache__/"
        - "--exclude=venv/"
        #- "--delete"
        #- "--exclude=.editorconfig"
        #- "--exclude=.gitignore"
        #- "--exclude=robot_bringup/"
        #- "--exclude=robot_interfaces/"

  - name: Load mail notification password
    when: test_mail_notify_password_file | default('') | length > 0
    ansible.builtin.set_fact:
      __test_mail_notify_password: "{{ lookup('file', test_mail_notify_password_file) | trim }}"

  - name: Show mail notification settings
    when: __test_mail_notify_password is defined
    ansible.builtin.debug:
      msg:
        - "SMTP host: {{ test_mail_notify_smtp_host }}"
        - "SMTP port: {{ test_mail_notify_smtp_port }}"
        - "SMTP user: {{ test_mail_notify_username }}"
        - "Mail to: {{ test_mail_notify_to }}"
        - "Mail from: {{ test_mail_notify_from }}"
        - "Password length: {{ __test_mail_notify_password | length }}"

  - name: Send test notification e-mail
    when: __test_mail_notify_password is defined
    ansible.builtin.mail:
      host: "{{ test_mail_notify_smtp_host }}"
      port: "{{ test_mail_notify_smtp_port }}"
      username: "{{ test_mail_notify_username }}"
      password: "{{ __test_mail_notify_password }}"
      to: "{{ test_mail_notify_to }}"
      from: "{{ test_mail_notify_from }}"
      subject: "{{ test_mail_notify_subject }}"
      body: "{{ test_mail_notify_body }}"
      secure: starttls
    register: __test_mail_notify_result
    failed_when: false

  - name: Show mail module result
    when: __test_mail_notify_result is defined
    ansible.builtin.debug:
      var: __test_mail_notify_result
